name: Publish PR Docs

on:
  workflow_run:
    workflows: ["Pull Request Checks"]
    types: [completed]

jobs:
  publish:
    name: Publish PR Docs
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      pull-requests: write
    if: github.event.workflow_run.event == 'pull_request'
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Download docs artifact
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: pr-docs
        path: artifact-docs
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
      id: download

    - name: Get PR metadata from API
      if: steps.download.outcome == 'success'
      id: metadata
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        REPO: ${{ github.repository }}
      run: |
        # Get PR info using the commit SHA from the workflow run.
        # This is more secure than reading from an artifact because:
        # - The commit SHA comes from GitHub's event system, not fork-controlled code
        # - The API returns PRs that actually contain that commit
        # - Cannot be manipulated by malicious fork code
        PR_DATA=$(gh api "/repos/${REPO}/commits/${HEAD_SHA}/pulls" --jq '.[0]')

        if [ -z "$PR_DATA" ] || [ "$PR_DATA" = "null" ]; then
          echo "No PR found for commit ${HEAD_SHA}. The PR may have been merged already, or the API has not yet indexed this commit."
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Skip non-fork PRs â€” they're published directly by the build-docs workflow.
        IS_FORK=$(echo "$PR_DATA" | jq -r '.head.repo.fork // false')
        if [ "$IS_FORK" != "true" ]; then
          echo "This is a same-repo PR. Docs were already published by the build-docs workflow."
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
        PR_MERGED=$(echo "$PR_DATA" | jq -r '.merged_at')

        if [ "$PR_STATE" = "closed" ] && [ "$PR_MERGED" != "null" ]; then
          echo "PR has already been merged. Skipping docs publishing for this PR."
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "version=PR-$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "skip=false" >> $GITHUB_OUTPUT

    - uses: ./.github/actions/set-up-node
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true'

    - run: npm ci
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true'

    - name: Configure git
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true'
      run: |
        git config --global user.email "93315277+lime-opensource@users.noreply.github.com"
        git config --global user.name "Lime Technologies OSS"

    - name: Publish docs from artifact
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true'
      id: publish
      env:
        DOCS_VERSION: ${{ steps.metadata.outputs.version }}
        GH_TOKEN: ${{ secrets.PUBLISH_DOCS }}
      run: npm run docs:publish -- --v="$DOCS_VERSION" --fromArtifact=artifact-docs

    - name: Post PR comment
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true' && steps.publish.outcome == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PR_NUMBER: ${{ steps.metadata.outputs.pr_number }}
      run: node .github/scripts/post-pr-docs-comment.js
