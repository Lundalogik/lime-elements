name: Publish PR Docs

on:
  workflow_run:
    workflows: ["Pull Request Checks"]
    types: [completed]

jobs:
  publish:
    name: Publish PR Docs
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      pull-requests: write
    # Only run for fork PRs — same-repo PRs publish directly in build-docs.
    # Also skip if the upstream workflow failed — there's no artifact to publish.
    if: >-
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.head_repository.fork == true
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Download docs artifact
      uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
      with:
        name: pr-docs
        path: artifact-docs
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
      id: download

    - name: Get PR metadata from API
      if: steps.download.outcome == 'success'
      id: metadata
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        HEAD_REPO_OWNER: ${{ github.event.workflow_run.head_repository.owner.login }}
        HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        REPO: ${{ github.repository }}
      run: |
        # Get PR info from the head branch of the workflow run.
        # This is more secure than passing the data from the PR via an artifact,
        # because head_repository and head_branch come from GitHub's event
        # system, not fork-controlled code.
        PR_DATA=$(gh api "/repos/${REPO}/pulls" -X GET -f state=open -f "head=${HEAD_REPO_OWNER}:${HEAD_BRANCH}" --jq '.[0]')

        if [ -z "$PR_DATA" ] || [ "$PR_DATA" = "null" ]; then
          echo "No open PR found for ${HEAD_REPO_OWNER}:${HEAD_BRANCH}."
          echo "The PR may have been closed or merged."
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Verify the commit SHA matches (extra security check)
        PR_HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
        if [ "$PR_HEAD_SHA" != "$HEAD_SHA" ]; then
          echo "PR head SHA ($PR_HEAD_SHA) doesn't match workflow run SHA ($HEAD_SHA)."
          echo "The PR may have been updated. Skipping to avoid publishing stale docs."
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "version=PR-$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "skip=false" >> $GITHUB_OUTPUT

    - uses: ./.github/actions/set-up-node
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true'

    - run: npm ci
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true'

    - name: Configure git
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true'
      run: |
        git config --global user.email "93315277+lime-opensource@users.noreply.github.com"
        git config --global user.name "Lime Technologies OSS"

    - name: Publish docs from artifact
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true'
      id: publish
      env:
        DOCS_VERSION: ${{ steps.metadata.outputs.version }}
        GH_TOKEN: ${{ secrets.PUBLISH_DOCS }}
      run: npm run docs:publish -- --v="$DOCS_VERSION" --fromArtifact=artifact-docs

    - name: Post PR comment
      if: steps.download.outcome == 'success' && steps.metadata.outputs.skip != 'true' && steps.publish.outcome == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PR_NUMBER: ${{ steps.metadata.outputs.pr_number }}
      run: node .github/scripts/post-pr-docs-comment.js
