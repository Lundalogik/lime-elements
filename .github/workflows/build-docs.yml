name: Docs
on:
  workflow_call:
    inputs:
      version:
        description: 'The "name" of the version to be published.'
        required: true
        type: string
      forcePush:
        description: 'Pass `true` if git push should use `--force`.'
        required: false
        default: false
        type: boolean
      buildOnly:
        description: 'Pass `true` to only build the docs, but not publish them. (Used by PR checks where publishing is handled by the publish-pr-docs workflow.)'
        required: false
        default: false
        type: boolean
      prNumber:
        description: 'PR number to post a comment on after publishing. Only used when buildOnly is false.'
        required: false
        type: number
      ref:
        description: 'Git ref (branch, tag, or SHA) to checkout. If not specified, uses the default ref for the triggering event.'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'The "name" of the version to be published. IMPORTANT: This only _names_ the published docs, it does not affect what is actually published. This workflow always builds and publishes the docs for whatever is the latest in the branch on which it is run.'
        required: true
        type: string
      forcePush:
        description: 'Pass `true` if git push should use `--force`.'
        required: false
        default: false
        type: boolean

jobs:

  build-docs:
    name: Build Docs
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        ref: ${{ inputs.ref }}
    - uses: ./.github/actions/set-up-node
    - run: npm ci
    - run: git config --global user.email "93315277+lime-opensource@users.noreply.github.com"
    - run: git config --global user.name "Lime Technologies OSS"
    - name: Publish docs
      if: github.event_name == 'workflow_dispatch' || inputs.buildOnly == false
      env:
        DOCS_VERSION: ${{ inputs.version || github.event.inputs.version }}
        FORCE_PUSH: ${{ inputs.forcePush || github.event.inputs.forcePush || 'false' }}
        GH_TOKEN: ${{ secrets.PUBLISH_DOCS }}
      run: |
        if [ "$FORCE_PUSH" = "true" ]; then
          npm run docs:publish -- --v="$DOCS_VERSION" --forcePush
        else
          npm run docs:publish -- --v="$DOCS_VERSION"
        fi
    - name: Build docs for artifact
      if: inputs.buildOnly
      env:
        DOCS_VERSION: ${{ inputs.version }}
      run: npm run docs:publish -- --v="$DOCS_VERSION" --artifactMode
    - name: Upload docs artifact
      if: inputs.buildOnly
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: pr-docs
        path: |
          www/
          .kompendium/kompendium.json
          docs-index.html
          docs-index.css
        retention-days: 1

    - name: Post PR comment
      if: inputs.prNumber && inputs.buildOnly == false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PR_NUMBER: ${{ inputs.prNumber }}
      run: node .github/scripts/post-pr-docs-comment.js
