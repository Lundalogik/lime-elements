name: Docs
on:
  workflow_call:
    inputs:
      version:
        description: 'The "name" of the version to be published.'
        required: true
        type: string
      forcePush:
        description: 'Pass `true` if git push should use `--force`.'
        required: false
        default: false
        type: boolean
      buildOnly:
        description: 'Pass `true` to only build the docs, but not publish them. (Used by PR checks for dependabot and external contributors.)'
        required: false
        default: false
        type: boolean
      ref:
        description: 'Git ref (branch, tag, or SHA) to checkout. If not specified, uses the default ref for the triggering event.'
        required: false
        type: string
      prNumber:
        description: 'PR number for metadata (required when buildOnly is true).'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'The "name" of the version to be published. IMPORTANT: This only _names_ the published docs, it does not affect what is actually published. This workflow always builds and publishes the docs for whatever is the latest in the branch on which it is run.'
        required: true
        type: string
      forcePush:
        description: 'Pass `true` if git push should use `--force`.'
        required: false
        default: false
        type: boolean

jobs:

  build-docs:
    name: Build Docs
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        ref: ${{ inputs.ref }}
    - uses: ./.github/actions/set-up-node
    - run: npm ci
    - run: git config --global user.email "93315277+lime-opensource@users.noreply.github.com"
    - run: git config --global user.name "Lime Technologies OSS"
    - name: Publish docs
      if: github.event_name == 'workflow_dispatch' || inputs.buildOnly == false
      env:
        DOCS_VERSION: ${{ inputs.version || github.event.inputs.version }}
        FORCE_PUSH: ${{ inputs.forcePush || github.event.inputs.forcePush || 'false' }}
        GH_TOKEN: ${{ secrets.PUBLISH_DOCS }}
      run: |
        if [ "$FORCE_PUSH" = "true" ]; then
          npm run docs:publish -- --v="$DOCS_VERSION" --forcePush
        else
          npm run docs:publish -- --v="$DOCS_VERSION"
        fi
    - name: Build docs for artifact
      if: github.event_name == 'workflow_call' && inputs.buildOnly
      env:
        DOCS_VERSION: ${{ inputs.version }}
      run: npm run docs:publish -- --v="$DOCS_VERSION" --artifactMode
    - name: Write metadata
      if: github.event_name == 'workflow_call' && inputs.buildOnly
      run: |
        if [ -z "${{ inputs.prNumber }}" ]; then
          echo "prNumber input is required when buildOnly=true" >&2
          exit 1
        fi
        echo "${{ inputs.version }}" > pr-metadata.txt
        echo "${{ inputs.prNumber }}" >> pr-metadata.txt
    - name: Upload docs artifact
      if: github.event_name == 'workflow_call' && inputs.buildOnly
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: pr-docs
        path: |
          www/
          .kompendium/kompendium.json
          docs-index.html
          docs-index.css
        retention-days: 1
    - name: Upload metadata artifact
      if: github.event_name == 'workflow_call' && inputs.buildOnly
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: pr-docs-metadata
        path: pr-metadata.txt
        retention-days: 1
