{"version":3,"names":["async","sanitizeEmailHTML","html","file","unified","use","rehypeParse","rehypeSanitize","getEmailSanitizationSchema","tree","visit","node","sanitizeDangerousCss","sanitizeDangerousUrls","rehypeStringify","process","toString","defaultSrcProtocols","_b","_a","defaultSchema","protocols","src","schema","Object","assign","_c","undefined","attributes","table","_d","colgroup","_e","col","_f","_g","tagNames","_h","tagName","properties","safeSrc","getSafeEmailImageSrc","dataRemoteSrc","remoteSrc","getRemoteEmailImageSrc","trimmedSrc","trim","toLowerCase","startsWith","mimeType","getDataUrlMimeType","allowedMimeTypes","Set","has","lower","dataUrl","match","exec","style","stripDangerousCss","Array","isArray","children","child","type","value","css","dangerousPatterns","cleaned","pattern","replaceAll"],"sources":["./src/util/sanitize-email-html.ts"],"sourcesContent":["import { unified } from 'unified';\nimport rehypeParse from 'rehype-parse';\nimport rehypeSanitize from 'rehype-sanitize';\nimport rehypeStringify from 'rehype-stringify';\nimport { visit } from 'unist-util-visit';\nimport { defaultSchema } from 'rehype-sanitize';\nimport { Schema } from 'rehype-sanitize/lib';\n\n/**\n * Sanitizes email HTML to prevent XSS and other security issues while\n * preserving the original visual appearance (layout, colors, fonts, etc.).\n *\n * This differs from the markdown sanitizer (`sanitizeHTML`) in that:\n * - **All inline CSS is preserved** (no style property filtering).\n * - Dangerous CSS properties like `behavior`, `expression`, `-moz-binding` are removed.\n * - Standard dangerous tags/attributes are blocked (script, event handlers, javascript: URLs).\n *\n * @param html - The HTML string to sanitize (typically an email body).\n * @returns The sanitized HTML string.\n */\nexport async function sanitizeEmailHTML(html: string): Promise<string> {\n    const file = await unified()\n        .use(rehypeParse)\n        .use(rehypeSanitize, getEmailSanitizationSchema())\n        .use(() => {\n            return (tree: any) => {\n                visit(tree, 'element', (node) => {\n                    sanitizeDangerousCss(node);\n                    sanitizeDangerousUrls(node);\n                });\n            };\n        })\n        .use(rehypeStringify)\n        .process(html);\n\n    return file.toString();\n}\n\n/**\n * Returns a rehype-sanitize schema that allows all standard HTML elements\n * and attributes needed for rich email rendering, including `style`.\n */\nfunction getEmailSanitizationSchema(): Schema {\n    const defaultSrcProtocols = defaultSchema.protocols?.src ?? [];\n\n    const schema: Schema = {\n        ...defaultSchema,\n        protocols: {\n            ...(defaultSchema.protocols ?? undefined),\n            // Email bodies often embed images as data URLs. We allow `data:` here,\n            // but still validate the MIME type in `sanitizeDangerousUrls`.\n            src: [...defaultSrcProtocols, 'http', 'https', 'data'],\n        },\n        attributes: {\n            ...defaultSchema.attributes,\n            table: [\n                ...(defaultSchema.attributes.table ?? []),\n                // Email HTML often relies on these legacy attributes.\n                'cellpadding',\n                'cellPadding',\n                'cellspacing',\n                'cellSpacing',\n                'border',\n                'dir',\n                'width',\n                'height',\n            ],\n            colgroup: [...(defaultSchema.attributes.colgroup ?? []), 'span'],\n            col: [...(defaultSchema.attributes.col ?? []), 'width', 'span'],\n            '*': [\n                ...(defaultSchema.attributes['*'] ?? []),\n                'style', // Allow inline styles on all elements\n                // NOTE: rehype/parse maps `class` to the HAST property name\n                // `className`, which is what rehype-sanitize checks.\n                'className',\n                'class', // Keep for completeness\n                'id', // Allow id for anchors/internal navigation\n                // Used to store remote image URLs without loading them immediately.\n                'data-remote-src',\n                'dataRemoteSrc',\n            ],\n        },\n        // Allow common email-specific tags\n        tagNames: [\n            ...(defaultSchema.tagNames ?? []),\n            // Allow full-document HTML emails. These tags won't render as text,\n            // but keeping them avoids their contents being surfaced as plain text.\n            'html',\n            'head',\n            'body',\n            'title',\n            'meta',\n            // Preserve embedded email CSS.\n            'style',\n            // Preserve table column sizing when using <colgroup>/<col>.\n            'colgroup',\n            'col',\n            'center', // Deprecated but widely used in email\n            'font', // Deprecated but widely used in email\n        ],\n    };\n\n    return schema;\n}\n\n/**\n * Validates and normalizes potentially dangerous URL attributes.\n *\n * Currently only handles `<img src>` and allows safe embedded `data:image/*`.\n *\n * @param node - The HTML element node to sanitize.\n */\nfunction sanitizeDangerousUrls(node: any) {\n    if (!node?.tagName || node.tagName !== 'img') {\n        return;\n    }\n\n    const src = node.properties?.src;\n    if (typeof src !== 'string') {\n        return;\n    }\n\n    const safeSrc = getSafeEmailImageSrc(src);\n    if (safeSrc) {\n        node.properties.src = safeSrc;\n        delete node.properties['data-remote-src'];\n        delete node.properties.dataRemoteSrc;\n        return;\n    }\n\n    const remoteSrc = getRemoteEmailImageSrc(src);\n    if (remoteSrc) {\n        // Avoid loading remote images by default. Store the URL so the viewer can\n        // opt-in and restore it later.\n        node.properties['data-remote-src'] = remoteSrc;\n        delete node.properties.src;\n        return;\n    }\n\n    // Keep the <img> but strip the source.\n    delete node.properties.src;\n}\n\n/**\n * Returns a safe image `src` for email rendering.\n *\n * Only permits embedded `data:` URLs with an allow-listed image MIME type.\n *\n * @param src - The raw `src` attribute value.\n * @returns A safe `src` to keep, or `undefined` to strip it.\n */\nfunction getSafeEmailImageSrc(src: string): string | undefined {\n    const trimmedSrc = src.trim();\n    if (!trimmedSrc) {\n        return;\n    }\n\n    // Only allow embedded images. Loading remote images has privacy implications\n    // (tracking pixels) and may leak network details.\n    if (!trimmedSrc.toLowerCase().startsWith('data:')) {\n        return;\n    }\n\n    const mimeType = getDataUrlMimeType(trimmedSrc);\n    if (!mimeType) {\n        return;\n    }\n\n    const allowedMimeTypes = new Set([\n        'image/png',\n        'image/jpeg',\n        'image/jpg',\n        'image/gif',\n        'image/webp',\n        'image/bmp',\n        'image/x-icon',\n        'image/vnd.microsoft.icon',\n    ]);\n\n    if (!allowedMimeTypes.has(mimeType)) {\n        return;\n    }\n\n    return trimmedSrc;\n}\n\n/**\n * Returns a safe remote image URL to keep for later opt-in loading.\n *\n * @param src - The raw `src` attribute value.\n * @returns The remote URL if it is http/https.\n */\nfunction getRemoteEmailImageSrc(src: string): string | undefined {\n    const trimmedSrc = src.trim();\n    const lower = trimmedSrc.toLowerCase();\n    if (lower.startsWith('http://') || lower.startsWith('https://')) {\n        return trimmedSrc;\n    }\n}\n\n/**\n * Extracts the MIME type from a `data:` URL.\n *\n * @param dataUrl - A `data:` URL string.\n * @returns The MIME type if present.\n */\nfunction getDataUrlMimeType(dataUrl: string): string | undefined {\n    // data:[<mime type>][;charset=<charset>][;base64],<data>\n    const match = /^data:([^;,]+)(?:;charset=[^;,]+)?(?:;base64)?,/i.exec(\n        dataUrl\n    );\n    const mimeType = match?.[1]?.toLowerCase();\n    return mimeType || undefined;\n}\n\n/**\n * Removes dangerous constructs from inline CSS (style attributes and `<style>` tags).\n *\n * @param node - The HTML element node to sanitize.\n */\nfunction sanitizeDangerousCss(node: any) {\n    if (!node?.tagName) {\n        return;\n    }\n\n    if (node.properties?.style && typeof node.properties.style === 'string') {\n        node.properties.style = stripDangerousCss(node.properties.style);\n    }\n\n    if (node.tagName === 'style' && Array.isArray(node.children)) {\n        for (const child of node.children) {\n            if (child?.type === 'text' && typeof child.value === 'string') {\n                child.value = stripDangerousCss(child.value);\n            }\n        }\n    }\n}\n\n/**\n * Removes common script-capable CSS constructs.\n *\n * @param css - A CSS string from a style attribute or `<style>` tag.\n * @returns The CSS with dangerous constructs removed.\n */\nfunction stripDangerousCss(css: string): string {\n    // Minimal defensive filtering. We preserve styling for fidelity, but drop\n    // well-known script-capable constructs (mostly relevant in legacy engines).\n    const dangerousPatterns = [\n        /behavior\\s*:/gi,\n        /expression\\s*\\(/gi,\n        /-moz-binding\\s*:/gi,\n        /vbscript\\s*:/gi,\n        /javascript\\s*:/gi,\n    ];\n\n    let cleaned = css;\n    for (const pattern of dangerousPatterns) {\n        cleaned = cleaned.replaceAll(pattern, '');\n    }\n\n    return cleaned;\n}\n"],"mappings":"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"}